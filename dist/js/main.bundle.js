(()=>{"use strict";function t(){const t=document.querySelector("main");return e(t),t}function e(t){for(;t.hasChildNodes();)t.removeChild(t.lastChild)}function n(){return Math.round(Math.random())}function a(t){return Math.round(Math.random()*t)}class s{attackPattern;attackHistory={};attackQueue=[];constructor(t,e){this.playerId=e,this.game=t,this.init()}init(){this.attackPattern=this.generateAttackPattern(y)}generateAttackPattern(t){const e=[],a=n();for(let n=0;n<t;n++)for(let s=(a+n)%2;s<t;s+=2){const t={x:s,y:n};e.push(t)}return e}getRandomAttackCoordinate(){const t=a(this.attackPattern.length-1);return{...this.attackPattern[t],attackPatternIndex:t}}getAttackString(t){return`x${t.x}y${t.y}`}sendAttack(){const t=this.playerId?0:1,e=this.getAttackCoordinate(),n=this.getAttackString(e),a=this.game.makeAttack({coordinate:n,receivingPlayerId:t});if("invalid"!==a?.result)return this.updateAttackHistory(),this.recordAttack(e,a),{...a,...e,receivingPlayerId:t};"occupied"==a?.reason&&this.purgeOccupied(a)}getAttackCoordinate(){return this.attackQueue.length>0?{...this.attackQueue[0],source:"queue"}:{...this.getRandomAttackCoordinate(),source:"pattern"}}recordAttack(t,e){if(this.attackQueue.length>0)this.attackQueue.splice(0,1),this.recordAttackWithQueue(t,e);else{const n=t.attackPatternIndex;this.attackPattern.splice(n,1),this.recordAttackWithoutQueue(t,e)}}recordAttackWithoutQueue(t,e){"hit"==e.result&&this.generateScoutAttackQueue(t,y)}recordAttackWithQueue(t,e){switch(this.purgeCoordinateFromAttackPattern(t),e.result){case"hit":{const e=this.generateAttackInDirection(t,y);e&&this.attackQueue.unshift(e);break}case"sunk":{this.resetAttackQueue();const t=this.searchForUnsunkHit(this.attackHistory);t&&this.generateScoutAttackQueue(t,y);break}}}updateAttackHistory(){const t=this.playerId?0:1;this.attackHistory=this.game.getPublicBoards()[t].publicBoard}purgeCoordinateFromAttackPattern(t){const e=this.attackPattern.findIndex((e=>t.x==e.x&&t.y==e.y));-1!=e&&this.attackPattern.splice(e,1)}purgeOccupied(t){if("pattern"==t.source){const e=t.attackPatternIndex;this.attackPattern.splice(e,1)}"queue"==t.source&&this.attackQueue.splice(0,1)}generateScoutAttackQueue(t,e){const n=[];["n","s","w","e"].forEach((a=>{const s=this.generateAttackInDirection({...t,direction:a},e);if(s)return n.push(s)})),this.attackQueue=n}generateAttackInDirection({x:t,y:e,direction:n},a){switch(n){case"n":{const a={x:t,y:e-1,direction:n};if(a.y>=0&&!(this.getAttackString(a)in this.attackHistory))return a;break}case"s":{const s={x:t,y:e+1,direction:n};if(s.y<a&&!(this.getAttackString(s)in this.attackHistory))return s;break}case"w":{const a={x:t-1,y:e,direction:n};if(a.x>=0&&!(this.getAttackString(a)in this.attackHistory))return a;break}case"e":{const s={x:t+1,y:e,direction:n};if(s.x<a&&!(this.getAttackString(s)in this.attackHistory))return s;break}}}searchForUnsunkHit(t){const e=Object.keys(t).find((e=>t[e]?.hasShip&&!t[e]?.isSunk));if(e)return{x:Number(e.charAt(1)),y:Number(e.charAt(3))}}resetAttackQueue(){this.attackQueue=[]}}class i{constructor(t){this.shipLength=t.coordinates.length,this.status={},this.init(t)}init(t){t.coordinates.forEach((t=>{this.status[t]=!1}))}hit(t){t in this.status&&(this.status[t]=!0)}isSunk(){return Object.values(this.status).every((t=>t))}}class r{boardDatabase={};shipsDatabase={};shipNamesList=[];constructor(t){this.playerName=t.name,this.color=t.color,this.isComputer=t.isComputer}checkPlaceShipValid(t){return t.coordinates.every((t=>!(t in this.boardDatabase)))}placeShip(t){if(0==this.checkPlaceShipValid(t))return"invalid placement";let e=new i(t);this.shipsDatabase[t.id]=e,this.shipNamesList.push(t.id),t.coordinates.forEach((e=>{this.boardDatabase[e]={ship:this.shipsDatabase[t.id]}}))}receiveAttack(t){if(t in this.boardDatabase==0)return this.boardDatabase[t]={isAttacked:!0},{result:"miss"};let e=this.boardDatabase[t];return"isAttacked"in e==0&&"ship"in e==1?(e.isAttacked=!0,e.ship.hit(t),e.ship.isSunk()?(this.setCoordinatesSunk(e.ship.status),{result:"sunk",ship:e.ship}):{result:"hit"}):1==e.isAttacked?console.error("error receiveAttack(), grid has been attacked already"):void 0}setCoordinatesSunk(t){Object.keys(t).forEach((t=>{this.boardDatabase[t].isSunk=!0}))}getShipStatus(){return this.shipNamesList.reduce(((t,e)=>({...t,[e]:this.shipsDatabase[e].isSunk()})),{})}areAllShipsSunk(){const t=this.getShipStatus();return Object.values(t).every((t=>t))}getPublicBoard(){const t=this.boardDatabase,e=Object.keys(t).reduce(((e,n)=>{const a=t[n];return"isAttacked"in a?{...e,[n]:{isAttacked:!0,hasShip:"ship"in a,isSunk:"isSunk"in a}}:e}),{});return{playerName:this.playerName,color:this.color,isComputer:this.isComputer,publicBoard:e}}}function c(){const e=t(),n=document.createElement("div");n.setAttribute("class","game-display"),e.appendChild(n),o(n,0),o(n,1),d()}function o(t,e){const n={...m.players[e],playerId:e},{playerName:a}=n,s=document.createElement("div");s.setAttribute("class","game-display__player nes-container"),s.setAttribute("id",`player${e}`),t.appendChild(s);const i=document.createElement("h4");i.setAttribute("class","game-display__player-name"),i.textContent=`${a}'s Ships`,s.appendChild(i);const r=document.createElement("div");r.setAttribute("class","game-display__player-board"),r.setAttribute("data-playerid",e),s.appendChild(r),function(t,e){const{playerId:n,boardDatabase:a}=e,s=m.getOpponent(n).isComputer;for(let e=0;e<y;e++)for(let i=0;i<y;i++){const r=`x${i}y${e}`,c=document.createElement("div");c.setAttribute("class",`game-display__grid ${r}`),t.appendChild(c),s||h({grid:c,playerId:n,coordinate:r}),s&&r in a&&p(c)}}(r,n)}function d(){const t=m.activePlayer,e=t?0:1,n=[document.querySelector("#player0"),document.querySelector("#player1")];"auto"==m.config.mode||(n[t].classList.add("inactive"),function(t){t.classList.remove("inactive")}(n[e]))}function u(t,e){switch(e.result){case"hit":!function(t){const e=document.createElement("i");t.classList.add("hit"),t.appendChild(e),e.setAttribute("class","nes-icon close")}(t);break;case"miss":!function(t){const e=document.createElement("i");t.classList.add("miss"),t.appendChild(e),e.setAttribute("class","fas fa-square-full")}(t);break;case"sunk":l(t,e);break;case"won":l(t,e),function(t){const e=document.querySelector("body"),n=document.createElement("div");n.setAttribute("class","mask"),e.appendChild(n);const a=document.createElement("div");a.setAttribute("class","win-popup nes-container is-rounded"),n.appendChild(a);const s=document.createElement("h3");s.setAttribute("class","win-popup__text"),s.textContent=`${t} has won!`,a.appendChild(s);const i=document.createElement("h4");i.setAttribute("class","win-popup__text"),i.textContent="Click to play again",a.appendChild(i),n.addEventListener("click",(()=>{n.remove(),$()}))}(e.winningPlayer)}}function l(t,n){const a=t.parentElement,s=`.${Object.keys(n.ship.status).join(", .")}`;a.querySelectorAll(s).forEach((t=>{t.classList.remove("hit","reveal"),t.classList.add("sunk"),e(t)}))}function p(t){t.classList.contains("sunk")||t.classList.add("reveal")}function h({grid:t,playerId:e,coordinate:n}){t.addEventListener("click",(()=>{const a=m.makeAttack({coordinate:n,receivingPlayerId:e});d(),u(t,a)}))}const m=new class{players=[];activePlayer=0;hasStarted=!1;computer={};config={mode:""};createPlayer(t){this.players.length>=2||(t.isComputer&&(this.computer[this.activePlayer]=new s(this,this.activePlayer)),this.players.push(new r(t)),this.advanceTurn())}placeShips(t){const e=this.players[this.activePlayer];return t.forEach((t=>{e.placeShip(t)})),this.advanceTurn(),e}advanceTurn(){this.activePlayer?this.activePlayer=0:this.activePlayer=1}getMyName(){return this.players[this.activePlayer].playerName}getOpponentsName(){return this.getOpponent().playerName}getOpponent(t=this.activePlayer){return 1==t?this.players[0]:this.players[1]}getPublicBoards(){return[this.players[0].getPublicBoard(),this.players[1].getPublicBoard()]}getMyBoard(){return this.players[this.activePlayer].boardDatabase}isInputComplete(t){return this.players.every((e=>t.every((t=>t.id in e.shipsDatabase))))}startGame(t){this.hasStarted||(this.hasStarted=1,this.activePlayer=t),this.checkAutoMode()&&(this.config.mode="auto"),this.players[this.activePlayer].isComputer&&this.makeComputerAttack()}makeComputerAttack(){setTimeout((()=>{!function(t){if(!t)return;const{receivingPlayerId:e,x:n,y:a}=t;u(document.querySelector(`#player${e} .x${n}y${a}`),t),d()}(this.computer[this.activePlayer].sendAttack())}),1e3)}makeAttack({coordinate:t,receivingPlayerId:e}){if(e==this.activePlayer)return console.error("invalid playerId"),{result:"invalid",reason:"playerId"};const n=this.getOpponent(),a=n.receiveAttack(t),s=n.areAllShipsSunk();return a?"sunk"==a.result&&s?{result:"won",winningPlayer:this.getMyName(),ship:a.ship}:(this.advanceTurn(),n.isComputer&&this.makeComputerAttack(),a):(console.error("invalid attack"),{result:"invalid",reason:"occupied"})}resetGame(){this.players=[],this.activePlayer=0,this.hasStarted=!1}checkAutoMode(){return this.players[0].isComputer&&this.players[1].isComputer}},y=10,b=[{id:"carrier",shipLength:5},{id:"battleship",shipLength:4},{id:"cruiser",shipLength:3},{id:"submarine",shipLength:3},{id:"destroyer",shipLength:2}];function k(){const e=t(),a=`${m.getMyName()}'s Ships`,s=document.createElement("div");s.className="place-ships nes-container",e.appendChild(s);const i=document.createElement("h3");i.textContent=a,i.className="place-ships__title",s.appendChild(i);const r=document.createElement("div");r.className="place-ships__board",x(r),s.appendChild(r);const o=document.createElement("div");o.className="place-ships__desc nes-text is-error",s.appendChild(o);const d=document.createElement("h6");d.textContent="Drag and drop, double click to rotate",o.appendChild(d),_(S(b,y)),function(e){const a=document.createElement("button");a.textContent="Continue",a.type="button",a.className="place-ships__button place-ships__button--submit nes-btn is-success",e.appendChild(a),a.addEventListener("click",(()=>{const e=function(t){return t.reduce(((t,e)=>{const n=document.querySelectorAll(`.${e.id}`),a=[];return n.forEach((t=>{a.push(t.id)})),[...t,{id:e.id,coordinates:a}]}),[])}(b),a=m.getOpponent();if(m.placeShips(e),"Computer"==a.playerName&&a.isComputer){const t=S(b,y);m.placeShips(t)}m.isInputComplete(b)?function(){const e=t(),a=m.getMyName(),s=m.getOpponentsName(),i=document.createElement("div");i.setAttribute("class","select-player nes-container"),e.appendChild(i);const r=document.createElement("h4");r.setAttribute("class","select-player__title"),r.textContent="Select First Mover:",i.appendChild(r);const o=document.createElement("button");o.setAttribute("class","select-player__button nes-btn"),o.type="button",o.textContent=a,i.appendChild(o);const d=document.createElement("button");d.setAttribute("class","select-player__button nes-btn"),d.type="button",d.textContent=s,i.appendChild(d);const u=document.createElement("button");u.setAttribute("class","select-player__button nes-btn is-warning"),u.type="button",u.textContent="Random",i.appendChild(u),o.addEventListener("click",(()=>{m.startGame(0),c()})),d.addEventListener("click",(()=>{m.startGame(1),c()})),u.addEventListener("click",(()=>{const t=n();m.startGame(t),c()}))}():function(e,n){const a=t(),s=`Pass device to ${e}`,i=document.createElement("div");i.setAttribute("class","pass-device nes-container is-rounded"),a.appendChild(i);const r=document.createElement("h3");r.textContent=s,i.appendChild(r);const c=document.createElement("h4");c.textContent="Click to continue",i.appendChild(c),i.addEventListener("click",(()=>{i.remove(),n()}))}(a.playerName,k)}))}(s),function(t){const e=document.createElement("button");e.textContent="Randomize",e.type="button",e.className="place-ships__button place-ships__button--randomize nes-btn is-warning",t.appendChild(e),e.addEventListener("click",(()=>{_(S(b,y))}))}(s)}function g(t,e,n,a){return P(t,e,n,a).map((t=>document.getElementById(t)))}function f(t,e){return t.some((t=>t.classList.contains("occupied")&&!t.classList.contains(e)))}function C(t,e,n,a,s){const i=s-n;switch(a){case"x":return t<=i;case"y":return e<=i}}function v(t,e,n,a,s,i,r){if(!C(e,n,a,s,i))return!1;return!f(r,t)}function A(t,e){document.querySelectorAll(`.${t}`).forEach((e=>{e.classList.remove(t),e.classList.remove("occupied")})),e.forEach((e=>{e.classList.add(t),e.classList.add("occupied")}))}function E(t,{id:e,shipLength:n,orientation:a="y"}){const s=document.createElement("div"),i="y"==a?"grid-column":"grid-row";s.setAttribute("class",`place-ships__ship-container ${i}`),s.setAttribute("draggable","true"),s.setAttribute("id",e),s.setAttribute("data-orientation",a),s.setAttribute("data-length",n),t.appendChild(s),s.addEventListener("dragstart",(t=>{t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move";const a={id:e,dragoffset:t.target.dataset.dragoffset,orientation:t.target.dataset.orientation,length:n};t.dataTransfer.setData("text/plain",JSON.stringify(a)),setTimeout((()=>{s.classList.add("hidden")}),0)})),s.addEventListener("dragend",(()=>{setTimeout((()=>{s.classList.remove("hidden")}),0)})),s.addEventListener("dblclick",(()=>{!function(t){const e=t.dataset,n=t.parentElement.dataset,a=t.id,s=n.x,i=n.y,r=e.length,c=e.orientation,o=function(t,e,n,a,s,i){for(let r=0;r<s;r++)for(let c=0;c<s;c++){const o="x"==a?Number(t)-r:Number(t)+c,d="y"==a?Number(e)-r:Number(e)+c,u=C(o,d,s,a,i);if(console.log(`x${o}y${d} isInbound: ${u}`),u){const t=g(o,d,s,a),e=f(t,n);if(!e)return console.log(t,`isOccupied: ${e}`),{newX:o,newY:d,targetNodes:t}}}}(s,i,a,"x"==c?"y":"x",r,y);o&&(!function(t,e){t.classList.toggle("grid-row"),t.classList.toggle("grid-column"),t.dataset.orientation="x"==t.dataset.orientation?"y":"x",e[0].appendChild(t)}(t,o.targetNodes),A(a,o.targetNodes))}(s)}));for(let t=0;t<n;t++){const e=document.createElement("div");e.className="place-ships__ship-grid",e.addEventListener("mousedown",(e=>{e.target.parentElement.setAttribute("data-dragOffset",t)})),s.appendChild(e)}}function x(t){for(let e=0;e<y;e++)for(let n=0;n<y;n++){const a=document.createElement("div");a.setAttribute("data-x",`${n}`),a.setAttribute("data-y",`${e}`),a.id=`x${n}y${e}`,a.className="place-ships__grid",t.appendChild(a),a.addEventListener("dragover",(t=>t.preventDefault())),a.addEventListener("dragenter",(t=>t.preventDefault())),a.addEventListener("drop",(t=>{const e=JSON.parse(t.dataTransfer.getData("text/plain")),n=t.target.dataset,a="x"==e.orientation?n.x-e.dragoffset:n.x,s="y"==e.orientation?n.y-e.dragoffset:n.y,i=g(a,s,e.length,e.orientation);if(!v(e.id,a,s,e.length,e.orientation,y,i))throw new Error("invalid ship placement");A(e.id,i);const r=`x${a}y${s}`,c=document.getElementById(r),o=document.getElementById(e.id);c.appendChild(o),t.dataTransfer.clearData()}))}}function _(t){!function(){const t=document.querySelector(".place-ships__board");e(t),x(t)}(),t.forEach((t=>{const e=t.coordinates[0],n=e.charAt(1),a=e.charAt(3),s=document.querySelector(`#${e}`),i=g(n,a,t.shipLength,t.orientation);E(s,t),A(t.id,i)}))}function S(t,e){const s=[];let i=[];return t.forEach((t=>{const r=function({id:t,shipLength:e},s,i){const r=n()?"x":"y",c="x"==r?i-e-1:i-1,o="y"==r?i-e-1:i-1;let d=[];for(;0===d.length;){const t=P(a(c),a(o),e,r);if(!t.some((t=>s.some((e=>e==t))))){d=t;break}}return{id:t,shipLength:e,coordinates:d,orientation:r}}(t,i,e);s.push(r),i=[...i,...r.coordinates]})),s}function P(t,e,n,a){let s=[];switch(a){case"x":for(let a=0;a<n;a++)s.push(`x${Number(t)+a}y${e}`);break;case"y":for(let a=0;a<n;a++)s.push(`x${t}y${Number(e)+a}`)}return s}function L(){const e=t(),n="pvp"==m.config.mode,a=`Enter your name${n?"s":""}:`,s=n?"Player One":"Player",i=document.createElement("form");i.className="name-input nes-container",e.appendChild(i);const r=document.createElement("h4");r.textContent=a,r.className="name-input__title",i.appendChild(r),N(i,0,s),n&&N(i,1,"Player Two");const c=document.createElement("button");c.textContent="Continue",c.type="submit",c.className="name-input__button nes-btn is-success",i.appendChild(c),i.addEventListener("submit",(t=>{t.preventDefault();const e=t.target.elements;[0,1].forEach((t=>{const n=e[`name${t}`]?{name:e[`name${t}`].value,isComputer:e[`auto${t}`].checked}:{name:"Computer",isComputer:!0};m.createPlayer(n)})),k()}))}function N(t,e,n){const a=document.createDocumentFragment(),s=document.createElement("input");s.name=`name${e}`,s.placeholder=n,s.required="true",s.type="text",s.autocomplete="off",s.className="name-input__text-input nes-input",a.appendChild(s);const i=document.createElement("label");i.className="name-input__auto-label",a.appendChild(i);const r=document.createElement("input");r.name=`auto${e}`,r.type="checkbox",r.className="nes-checkbox",i.appendChild(r);const c=document.createElement("span");c.textContent="Auto",i.appendChild(c),t.appendChild(a)}function $(){const e=t(),n=document.createElement("div");n.className="start nes-container";const a=document.createElement("h1");a.textContent="Battleship",a.className="start__title",n.appendChild(a);const s=document.createElement("h4");s.textContent="Start Game",s.className="start__desc",n.appendChild(s);const i=document.createElement("button");i.textContent="1 Player",i.type="button",i.className="start__button nes-btn",i.addEventListener("click",(()=>{m.resetGame(),m.config.mode="computer",L()})),n.appendChild(i);const r=document.createElement("button");r.textContent="2 Players",r.type="button",r.className="start__button nes-btn",r.addEventListener("click",(()=>{m.resetGame(),m.config.mode="pvp",L()})),n.appendChild(r),e.appendChild(n)}$(),function(){const t=document.querySelector("body"),e=document.createElement("a");e.href="https://github.com/tzunwip/battleship",e.target="_blank",e.classList="icon__github",t.appendChild(e);const n=document.createElement("i");n.classList="nes-icon github",e.appendChild(n)}()})();